Решил написать небольшую инструкцию о том, как загружать звонки из сервиса calltouch в БД Clickhouse. Инструкция будет полезна компаниям и специалистам, использующим в качестве сервиса коллтрекинга Calltouch и Clickhouse в качестве СУБД. В скрипте, который прилагается к инструкции используется язык python Владение им облегчит процесс настройки скрипта. Но если вы не знакомы с этим языком, то сложностей возникнуть не должно, т.к. я постарался все максимально подробно описать.

Подготовительный процесс состоит из нескольких этапов.
# Получение ключа google
Переходим по адресу https://console.cloud.google.com/ Раздел “API’s & Services”

Выбираем проект. Если проектов пока нет, создаем новый.



В разделе APIs & SERVICES нажимаем “ENABLE APIS AND SERVICES”


Включаем Google Sheets API и Google Drive API.
Переходим в раздел “IAM & Admin”, пункт “Service Accounts”. Нам нужно создать сервисный аккаунт.

Придумываем имя и id сервисного аккаунта, выбираем роль owner

Затем заходим в сервисный аккаунт, раздел Keys


Создаем новый ключ JSON
Ключ должен автоматически скачаться.Сохраняем его в удобное место.

Ключ получен, переходим к следующему шагу- создание таблиц.
Создаем необходимые таблицы.

Создаем таблицу “calltouch_accounts”, с листами “accounts и “logs”.
Выдаем разрешение на почту сервисного аккаунта (указана в графе “Email” в списке сервисных аккаунтов).
На 1 строке таблицы accounts создаем столбцы:
site - название кабинета, url сайта и т.д. Указывается справочно для удобства навигации.
id - site_id из личного кабинета calltouch 
key - API ключ из кабинета calltouch (посмотреть можно в настройках сайта, в разделе “интеграции”)
date_from -  дата начала сбора данных (задается при первом запуске скрипта)
date_to - дата окончания сбора данных (задается при первом запуске скрипта)
status - статус сбора. Перед первым запуском нужно установить значение 1. В дальнейшем статусы будут меняться автоматически. 2- будет означать, что первый запуск выполнен успешно и данные собраны, ошибка- что где-то произошел сбой (подробнее в логах).
Названия столбцов могут отличаться, но главное- сохранять их порядок.
Не забудьте заполнить таблицу данными. 
ВАЖНО: date_to и date_from вводятся в формате dd/mm/yyyy.

В таблице “logs” будет 3 столбца:
Account - аккаунт calltouch
Date - Дата и время события
Log - Собственно само сообщение
У вас они тоже могут иметь другие названия, но порядок будет такой.


# Настройка скрипта

В скрипте меняем строки 19-39, а именно

db_config = {
    'user': 'name',  # имя пользователя. Меняем name на имя пользователя Clickhouse
    'pwd': urllib.parse.quote_plus('password'),  # пароль пользователя. Меняем password
    'host': '11.111.111.111',  # адрес сервера. Меняем 11.111.111.111
    'port': 0000,  # порт подключения. Меняем 0000
    'db': 'db_name'  # название базы данных. Меняем db_name
}  


spreadsheetId = 'id' # здесь вместо id вставляем id таблицы, созданной на шаге 2. 
Id можно посмотреть в url


По умолчанию у меня выгружаются указанные ниже поля. при необходимости, поменяйте их на свои.
fields = ['siteId', 'callId', 
          'date', 'callerNumber', 'redirectNumber',
          'phoneNumber', 'uniqTargetCall', 'source',
          'medium', 'keyword', 'ref', 'hostname',
          'utmSource', 'utmMedium', 'utmCampaign',
          'utmContent', 'utmTerm']



Сохраненный файл с ключом 
CREDENTIALS_FILE = '' # здесь указывайте путь к файлу с ключом из шага 1.

Подготовка скрипта на этом закончена.

# Создаем таблицу в CH. 
Для приведенных выше столбцов запрос выглядит так:

create table calls (siteId String, callId String, 
          date Datetime, callerNumber String, redirectNumber String,
          phoneNumber String, uniqTargetCall String, source String,
          medium String, keyword String, ref String, hostname String,
          utmSource String, utmMedium String, utmCampaign String,
          utmContent String, utmTerm String)
          ENGINE = MergeTree()
          ORDER BY date


# Установка пакетов и библиотек.
Если у вас не установлен Python, то установите его. Для этого переходим на python.org и скачиваем нужную версию. У меня 3.9.13, с ней всё работает стабильно.

После установки, скачиваем библиотеки. Опишу на примере Windows.
Запускаем Winows PowerShell. В командной строке по очереди пишем

pip install httplib2==0.21.0
pip install apiclient==1.0.4
pip install oauth2client==4.1.3
pip install pandas==1.5.2
pip install requests==2.28.1
pip install sqlalchemy==1.4.46
pip install urllib3==1.26.13
pip install clickhouse-sqlalchemy==0.2.3

Все необходимые пакеты установлены и скрипт готов к работе.
